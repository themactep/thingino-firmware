#!/bin/sh

start() {
	DROPBEAR_ARGS="$DROPBEAR_ARGS -R -B -k -p 22 -K 300"

	# If /etc/dropbear is a symlink to /var/run/dropbear, and
	#   - the filesystem is RO (i.e. we can not rm the symlink),
	#     create the directory pointed to by the symlink.
	#   - the filesystem is RW (i.e. we can rm the symlink),
	#     replace the symlink with an actual directory
	if [ -L /etc/dropbear ] && [ "$(readlink /etc/dropbear)" = "/var/run/dropbear" ]; then
		if rm -f /etc/dropbear > /dev/null 2>&1; then
			mkdir -p /etc/dropbear
		else
			echo "No persistent location to store SSH host keys. New keys will be"
			echo "generated at each boot. Are you sure this is what you want to do?"
			mkdir -p "$(readlink /etc/dropbear)"
		fi
	fi

	SSHKEY_ENV=$(fw_printenv -n sshkey_ed25519)
	DROPBEAR_KEY="/etc/dropbear/dropbear_ed25519_host_key"

	[ -s "$DROPBEAR_KEY" ] || {
		[ -n "$SSHKEY_ENV" ] && echo "$SSHKEY_ENV" | base64 -d | gzip -d > $DROPBEAR_KEY && logger -t S50dropbear "SSH Key restored." || {
			dropbearkey -t ed25519 -f $DROPBEAR_KEY && logger -t S50dropbear "Generated dropbear host keys."
		}
	}

	[ -z "$SSHKEY_ENV" ] && [ -s "$DROPBEAR_KEY" ] && {
		SSHKEY_ENV=$(gzip -c $DROPBEAR_KEY | base64 | tr -d '\n')
		fw_setenv sshkey_ed25519 "$SSHKEY_ENV" && logger -t S50dropbear "SSH key backed up."
	}

	printf "Starting dropbear sshd: "
	umask 077

	start-stop-daemon -S -q -p /var/run/dropbear.pid --exec /usr/sbin/dropbear -- $DROPBEAR_ARGS
	[ $? = 0 ] && echo "OK" || echo "FAIL"
}

stop() {
	printf "Stopping dropbear sshd: "
	start-stop-daemon -K -q -p /var/run/dropbear.pid
	[ $? = 0 ] && echo "OK" || echo "FAIL"
}

case "$1" in
	start | stop)
		$1
		;;

	restart | reload)
		stop
		start
		;;

	*)
		echo "Usage: $0 {start|stop|restart|reload}"
		exit 1
		;;
esac

exit $?
