#!/bin/sh

. /usr/share/common

show_help() {
	echo "Usage: $0 [options]
Where:
	-m message  Message to send to webhook.
	-s          Attach snapshot to the webhook.
	-c          Attach videoclips to the webhook.
	-u url      Webhook URL.
	-v          Verbose output.
	-h          Show this help.
" >&2
	exit 0
}

cleanup() {
	[ -f "$snapshot_attachment" ] && rm "$snapshot_attachment"
	[ -f "$video_attachment" ] && rm "$video_attachment"
}

while getopts m:scu:vh flag; do
	case "$flag" in
		m) webhook_message=$OPTARG ;;
		s) webhook_attach_snapshot="true" ;;
		c) webhook_attach_videoclip="true" ;;
		u) webhook_url=$OPTARG ;;
		v) verbose="true" ;;
		h | *) show_help ;;
	esac
done

# validators
[ -z "$webhook_url" ] && die "Webhook URL not found"

# command
if [ "true" = "$verbose" ]; then
	command="$CURL --verbose"
else
	command="$CURL --silent"
fi

# snapshot attachment
if [ "true" = "$webhook_attach_snapshot" ]; then
	snapshot_attachment=$(mktemp -u).jpg
	cp -f "$SNAPSHOT_FILE" "$snapshot_attachment"
	command="$command -F \"image=@$snapshot_attachment\""
fi

# video attachment
if [ "true" = "$webhook_attach_videoclip" ] && [ -f "$MOTION_VIDEO_FILE" ]; then
	video_attachment=$(mktemp -u).mp4
	cp -f "$MOTION_VIDEO_FILE" "$video_attachment"
	command="$command -F \"video=@$video_attachment\""
fi

# Add message and url to the command
command="$command -F \"message=$webhook_message\" --url \"$webhook_url\""

[ "true" = "$verbose" ] && echo_command "$command"

result=$(sh -c "$command" 2>&1)
if [ $? -eq 0 ] ; then
	[ "true" = "$verbose" ] && echo_info "$result"
else
	cleanup
	die "Failed to send webhook message"
fi

cleanup

exit 0
