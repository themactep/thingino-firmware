#!/bin/env sh

. /usr/share/common

show_help() {
	echo "Usage: $0 [options]
Where:
	-m message  Message to send to webhook.
	-s          Attach snapshot to the webhook.
	-c          Attach videoclips to the webhook.
	-u url      Webhook URL.
	-v          Verbose output.
	-h          Show this help.
" >&2
	exit 0
}

while getopts chm:su:v flag; do
	case "$flag" in
		m) webhook_message=$OPTARG ;;
		s) webhook_attach_snapshot="true" ;;
		c) webhook_attach_videoclip="true" ;;
		u) webhook_url=$OPTARG ;;
		v) verbose="true" ;;
		h | *) show_help ;;
	esac
done

if [ -z "$webhook_url" ]; then
	echo_error "Webhook URL not found"
	cleanup
	exit 1
fi

if [ "true" = "$verbose" ]; then
	command="$CURL --verbose"
else
	command="$CURL --silent"
fi

if [ "true" = "$webhook_attach_snapshot" ]; then
	photo=$(copy_photo)
	command="$command -F 'image=@$photo'"
fi

if [ "true" = "$webhook_attach_videoclip" ]; then
	check_vbuffer
	inode=$(stat -c%i $VBUFFER_FILE)

	video1=$(copy_video)
	command="$command -F 'video1=@$video1'"

	while [ $inode -eq $(stat -c%i $VBUFFER_FILE) ]; do
		n=$((n + 1))
		if [ "$n" -ge 10 ]; then
			echo_error "Give up after $n attempts."
			cleanup
			exit 1
		fi
		sleep 1
	done

	video2=$(copy_video)
	command="$command -F 'video2=@$video2'"
fi

command="$command -F \"message=$webhook_message\""
command="$command --url \"$webhook_url\""

if [ "true" = "$verbose" ]; then
	echo_command "$command"
fi

if ! sh -c "$command" >/dev/null; then
	echo_error "Failed to send webhook message"
	cleanup
	exit 1
fi

cleanup

exit 0
