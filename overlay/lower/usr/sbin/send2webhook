#!/bin/env sh

. /usr/share/common
. /usr/share/common_send2

show_help() {
	echo "Usage: $0 [options]
Where:
	-m message  Message to send to webhook.
	-s          Attach snapshot to the webhook.
	-c          Attach videoclips to the webhook.
	-u url      Webhook URL.
	-v          Verbose output.
	-h          Show this help.
" >&2
	exit 0
}

read_config() {
        local CONFIG_FILE=/etc/send2.json
        [ -f "$CONFIG_FILE" ] || return

	       url=$(jct $CONFIG_FILE get webhook.url)
           message=$(jct $CONFIG_FILE get webhook.message)
        send_photo=$(jct $CONFIG_FILE get webhook.send_photo)
        send_video=$(jct $CONFIG_FILE get webhook.send_video)
}

read_config

while getopts chm:su:v flag; do
	case "$flag" in
		m) message=$OPTARG ;;
		s) send_photo="true" ;;
		c) send_video="true" ;;
		u) url=$OPTARG ;;
		v) verbose="true" ;;
		h | *) show_help ;;
	esac
done

if [ -z "$url" ]; then
	echo_error "Webhook URL not found"
	exit 1
fi

if [ "true" = "$verbose" ]; then
	command="$CURL --verbose"
else
	command="$CURL --silent"
fi

if [ "true" = "$send_photo" ]; then
	photo=$(copy_photo)
	command="$command -F 'image=@$photo'"
fi

if [ "true" = "$send_video" ]; then
	check_vbuffer
	inode=$(stat -c%i $VBUFFER_FILE)

	video1=$(copy_video)
	command="$command -F 'video1=@$video1'"

	while [ $inode -eq $(stat -c%i $VBUFFER_FILE) ]; do
		n=$((n + 1))
		if [ "$n" -ge 10 ]; then
			echo_error "Give up after $n attempts."
			exit 1
		fi
		sleep 1
	done

	video2=$(copy_video)
	command="$command -F 'video2=@$video2'"
fi

command="$command -F \"message=$message\""
command="$command --url \"$url\""

if [ "true" = "$verbose" ]; then
	echo_command "$command"
fi

if ! sh -c "$command" >/dev/null; then
	echo_error "Failed to send webhook message"
	exit 1
fi

exit 0
