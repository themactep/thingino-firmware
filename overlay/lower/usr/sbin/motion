#!/bin/sh
# Triggered on a motion event

. /usr/share/common

singleton "$0"

MOTION_ALARM="/run/motion/motion_alarm"
MOTION_ALARM_DIR=$(dirname "$MOTION_ALARM")
[ -d "$MOTION_ALARM_DIR" ] || mkdir -p "$MOTION_ALARM_DIR"

MOTION_STOP_FILE="/run/motors.pid"

MOTION_VIDEO_FILE="/tmp/vbuffer.mp4"
MOTION_VIDEO_CHANNEL=0
MOTION_VIDEO_LENGTH=10

start() {
	echo_info "Start motion"
	if [ -f "$MOTION_STOP_FILE" ]; then
		echo_error "Motor motion file present. Exiting."
		exit 1
	fi

	echo_info "Set $MOTION_ALARM"
	touch "$MOTION_ALARM"

	# record a video clip
	echo_info "Start recording $MOTION_VIDEO_FILE"
	echo "START $MOTION_VIDEO_FILE $MOTION_VIDEO_LENGTH $MOTION_VIDEO_CHANNEL" > /run/prudynt/mp4ctl
	echo_info "Motion video is ready."
}

stop() {
	echo_info "Stop motion"

	if [ -f "$MOTION_ALARM" ]; then
		echo_info "Remove $MOTION_ALARM"
		rm -f "$MOTION_ALARM"
	fi
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	*)
		start
		;;
esac

exit 0
