#!/bin/sh
# Triggered on a motion event

. /usr/share/common

singleton "$0"

MOTION_ALARM="/run/motion/motion_alarm"
MOTION_ALARM_DIR=$(dirname "$MOTION_ALARM")
[ -d "$MOTION_ALARM_DIR" ] || mkdir -p "$MOTION_ALARM_DIR"

MOTION_STOP_FILE="/run/motors.pid"

MP4_CTL_FIFO="/run/prudynt/mp4ctl"
channel_state_file() {
	local channel="$1"
	echo "/run/prudynt/mp4ctl-ch${channel}.active"
}

wait_for_recording_completion() {
	local channel="$1"
	local timeout="$2"
	local waited=0
	local state_file
	state_file=$(channel_state_file "$channel")
	[ -z "$timeout" ] && timeout=0
	while : ; do
		if [ ! -f "$state_file" ]; then
			return 0
		fi
		if [ "$timeout" -gt 0 ] && [ "$waited" -ge "$timeout" ]; then
			return 1
		fi
		sleep 1
		waited=$((waited + 1))
	done
}

start() {
	echo_info "Start motion"

	channel=1
	duration=10

	if [ -f "$MOTION_STOP_FILE" ]; then
		echo_error "Motor motion file present. Exiting."
		exit 1
	fi

	echo_info "Set $MOTION_ALARM"
	touch "$MOTION_ALARM"

	echo_info "Start recording $duration sec clip from stream $channel as $MOTION_VIDEO_FILE"
	echo "START $MOTION_VIDEO_FILE $duration $channel" > "$MP4_CTL_FIFO"
	wait_timeout=$((duration + 5))
	if ! wait_for_recording_completion "$channel" "$wait_timeout"; then
		echo_warning "Recording channel $channel still active after ${wait_timeout}s"
	fi

	if [ "true" = "$motion_send2email" ]; then
		echo_info "Send alert to email"
		send2email &
	fi

	if [ "true" = "$motion_send2ftp" ]; then
		echo_info "Send alert to FTP"
		send2ftp &
	fi

	if [ "true" = "$motion_send2mqtt" ]; then
		echo_info "Send alert to MQTT"
		send2mqtt &
	fi

	if [ "true" = "$motion_send2telegram" ]; then
		echo_info "Send alert to Telegram"
		send2telegram motion &
	fi

	if [ "true" = "$motion_send2webhook" ]; then
		echo_info "Send alert to WebHook"
		send2webhook &
	fi

	if [ "true" = "$motion_send2ntfy" ]; then
		echo_info "Send alert to Ntfy"
		send2ntfy &
	fi

	if [ "true" = "$motion_playonspeaker" ]; then
		echo_info "Send alert to play on speaker"
		playonspeaker &
	fi
}

stop() {
	echo_info "Stop motion"

	if [ -f "$MOTION_ALARM" ]; then
		echo_info "Remove $MOTION_ALARM"
		rm -f "$MOTION_ALARM"
	fi
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	*)
		start
		;;
esac

exit 0
