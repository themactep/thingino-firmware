#!/bin/sh

plugin="dusk2dawn"

. /sbin/common-plugins

show_help() {
	echo "Usage: $0 [-x coord] [-y coord] [-d date] [-f] [-v] [-h]
  -x coord    Latitude.
  -y coord    Longitude.
  -r offset   Offset at sunRise (minutes).
  -s offset   Offset at sunSet (minutes).
  -d date     Date (default: today).
  -f          Force run.
  -v          Verbose output.
  -h          Show this help.
"
	quit_clean 0
}

time_with_offset() {
	h=$(jsonfilter -s "$json" -e @.results.$1 | awk -F[T:] '{print $2}' | sed 's/^0//')
	m=$(jsonfilter -s "$json" -e @.results.$1 | awk -F[T:] '{print $3}' | sed 's/^0//')
	echo $(((1440 + h * 60 + m + $2) % 1440))
}

# override config values with command line arguments
while getopts d:fr:s:x:y:vh flag; do
	case "$flag" in
		d)
			dusk2dawn_date=$OPTARG
			;;
		f)
			force_run="true"
			;;
		r)
			dusk2dawn_offset_sr=$OPTARG
			;;
		s)
			dusk2dawn_offset_ss=$OPTARG
			;;
		x)
			dusk2dawn_lat=$OPTARG
			;;
		y)
			dusk2dawn_lat=$OPTARG
			;;
		v)
			verbose="true"
			;;
		h | *)
			show_help
			;;
	esac
done

if [ "true" != "$dusk2dawn_enabled" ] && [ "true" != "$force_run" ]; then
	log "Dusk to Dawn is disabled."
	quit_clean 10
fi

if [ -z "$dusk2dawn_lat" ]; then
	log "Latitude is not set."
	dusk2dawn_lat="$(fw_printenv -n geolat)"
fi

if [ -z "$dusk2dawn_lng" ]; then
	log "Longitude is not set."
	dusk2dawn_lng="$(fw_printenv -n geolng)"
fi

if [ -z "$dusk2dawn_date" ]; then
	log "Date is today."
	dusk2dawn_date="today"
fi

# validate mandatory values
if [ -z "$dusk2dawn_lat" ]; then
	log "Cannot find latitude"
	quit_clean 11
fi

if [ -z "$dusk2dawn_lng" ]; then
	log "Cannot find longitude"
	quit_clean 12
fi

tz="$(fw_printenv -n timezone | tr ' ' '_')"

if [ -z "$dusk2dawn_runat" ]; then
	echo "Run at is not set"
	dusk2dawn_runat="4:44"
fi

runat_h=${dusk2dawn_runat%%:*}
runat_m=${dusk2dawn_runat##*:}

crontab_file=/etc/crontabs/root

sunrise_marker="# switch to day mode at sunrise (autogenerated)"
sunset_marker="# switch to night mode at sunset (autogenerated)"

api_url="https://api.sunrise-sunset.org/json"
url="${api_url}?formatted=0&date=${dusk2dawn_date}&lat=${dusk2dawn_lat}&lng=${dusk2dawn_lng}&tzid=${tz}"

tmpfile=$(mktemp)
command="curl --silent --connect-timeout $curl_timeout --max-time $curl_timeout"
# SOCK5 proxy, if needed
if [ "true" = "$ftp_socks5_enabled" ]; then
	. /etc/webui/socks5.conf
	command="$command --socks5-hostname ${socks5_host}:$socks5_port"
	command="$command --proxy-user ${socks5_login}:$socks5_password"
fi
command="$command --output $tmpfile --url \"$url\""

log "$command"
eval "$command" >> "$LOG_FILE" 2>&1

json=$(cat $tmpfile)
[ "true" = "$verbose" ] && echo "$json"

sunrise_time=$(time_with_offset "sunrise" $dusk2dawn_offset_sr)
sunrise_h=$((sunrise_time / 60))
sunrise_m=$((sunrise_time % 60))

sunset_time=$(time_with_offset "sunset" $dusk2dawn_offset_ss)
sunset_h=$((sunset_time / 60))
sunset_m=$((sunset_time % 60))

tmp_crontab_file=$(mktemp)
cp $crontab_file $tmp_crontab_file

sed -i "/dusk2dawn/d" $tmp_crontab_file
sed -i "/$sunset_marker/,+1d" $tmp_crontab_file
sed -i "/$sunrise_marker/,+1d" $tmp_crontab_file
{
	echo "# run dusk2dawn nightly at $dusk2dawn_runat"
	printf "%02d %02d * * * dusk2dawn\n" $runat_m $runat_h
	echo "$sunrise_marker"
	printf "%02d %02d * * * daynight day\n" $sunrise_m $sunrise_h
	echo "$sunset_marker"
	printf "%02d %02d * * * daynight night\n" $sunset_m $sunset_h
} >> $tmp_crontab_file

cp $tmp_crontab_file $crontab_file

[ "true" = "$verbose" ] && crontab -l

quit_clean 0
