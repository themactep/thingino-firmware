#!/bin/sh

plugin="dusk2dawn"

. /sbin/common-plugins

API_URL="https://api.sunrise-sunset.org/json"
CRONTAB_FILE=/etc/cron/crontabs/root
RUNAT_DEFAULT="4:44"
SS_MARK="# switch to day mode at sunrise (autogenerated)"
SR_MARK="# switch to night mode at sunset (autogenerated)"

show_help() {
	echo "Usage: $0 [-x coord] [-y coord] [-d date] [-f] [-v] [-h]
  -x coord    Latitude.
  -y coord    Longitude.
  -r offset   Offset at sunRise (minutes).
  -s offset   Offset at sunSet (minutes).
  -d date     Date (default: today).
  -f          Force run.
  -v          Verbose output.
  -h          Show this help.
"
	quit_clean 0
}

time_for_cron() {
	local t="$1"
	printf "%02d %02d" $((t % 60)) $((t / 60))
}

time_with_offset() {
	local h=$(jsonfilter -s "$json" -e @.results.$1 | awk -F[T:] '{print $2}' | sed 's/^0//')
	local m=$(jsonfilter -s "$json" -e @.results.$1 | awk -F[T:] '{print $3}' | sed 's/^0//')
	echo $(((1440 + h * 60 + m + $2) % 1440))
}

# override config values with command line arguments
while getopts d:fr:s:x:y:vh flag; do
	case "$flag" in
		d) dusk2dawn_date=$OPTARG ;;
		f) force_run="true" ;;
		r) dusk2dawn_offset_sr=$OPTARG ;;
		s) dusk2dawn_offset_ss=$OPTARG ;;
		x) dusk2dawn_lat=$OPTARG ;;
		y) dusk2dawn_lat=$OPTARG ;;
		v) verbose="true" ;;
		h | *) show_help ;;
	esac
done

[ "true" != "$dusk2dawn_enabled" ] && [ "true" != "$force_run" ] && die "Dusk to Dawn is disabled"

if [ -z "$dusk2dawn_lat" ]; then
	log "Latitude is not set"
	dusk2dawn_lat="$(fw_printenv -n geolat)"
fi

if [ -z "$dusk2dawn_lng" ]; then
	log "Longitude is not set"
	dusk2dawn_lng="$(fw_printenv -n geolng)"
fi

if [ -z "$dusk2dawn_date" ]; then
	log "Date is today"
	dusk2dawn_date="today"
fi

# validate mandatory values
[ -z "$dusk2dawn_lat" ] && die "Cannot find latitude"
[ -z "$dusk2dawn_lng" ] && die "Cannot find longitude"

tz="$(fw_printenv -n timezone | tr ' ' '_')"

if [ -z "$dusk2dawn_runat" ]; then
	echo "Run at is not set, default to $RUNAT_DEFAULT"
	dusk2dawn_runat="$RUNAT_DEFAULT"
fi

runat_h=${dusk2dawn_runat%%:*}
runat_m=${dusk2dawn_runat##*:}

command="$CURL --output - --url $API_URL?formatted=0&date=$dusk2dawn_date&lat=$dusk2dawn_lat&lng=$dusk2dawn_lng&tzid=$tz"
# cannot use log_and_run here because need a clear output
log "$command"
json=$($command)
[ "true" = "$verbose" ] && echo "$json"

sr_time=$(time_with_offset "sunrise" $dusk2dawn_offset_sr)
ss_time=$(time_with_offset "sunset" $dusk2dawn_offset_ss)

tmpfile=$(mktemp -u)
cp $CRONTAB_FILE $tmpfile
sed -i "/dusk2dawn/d" $tmpfile
sed -i "/$SR_MARK/,+1d" $tmpfile
sed -i "/$SS_MARK/,+1d" $tmpfile
{
	echo "# run dusk2dawn nightly at $dusk2dawn_runat"
	printf "%02d %02d * * * dusk2dawn\n" $runat_m $runat_h
	echo "$SS_MARK"
	echo "$(time_for_cron "$sr_time") * * * daynight day"
	echo "$SR_MARK"
	echo "$(time_for_cron "$ss_time") * * * daynight night"
} >> $tmpfile
cp $tmpfile $CRONTAB_FILE

[ "true" = "$verbose" ] && crontab -l

quit_clean 0
