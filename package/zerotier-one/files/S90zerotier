#!/bin/sh

. /usr/share/common

DAEMON="zerotier-one"
action="$1"
config_file=/etc/zerotier.json

validate() {
	nwid=$(jct "$config_file" get zerotier.nwid)
	if [ -z "$nwid" ]; then
		echo_error "No network defined"
		exit 1
	fi
}

join() {
	if [ ! -e "/var/lib/zerotier-one/networks.d/${nwid}.conf" ]; then
		sleep 2
		if zerotier-cli join "$nwid"; then
			play /usr/share/sounds/zerotiervpnisup.opus
		fi
	fi
}

abort_if_running() {
	pidof zerotier-one  > /dev/null
	if [ $? = 0 ]; then
		echo_error "ZeroTier already running"
		exit 1
	fi
}

case "$action" in
	force)
		abort_if_running
		validate
		echo_title "Starting ZeroTier-One"
		modprobe tun && $DAEMON -d >/dev/null 2>&1
		join
		;;
	start)
		abort_if_running
		validate
		if [ "true" != "$(jct "$config_file" get zerotier.enabled)" ]; then
			echo_error "ZeroTier-One service is disabled in $config_file"
			exit 1
		fi

		echo_title "Starting ZeroTier-One"
		modprobe tun && $DAEMON -d >/dev/null 2>&1
		join
		;;
	stop)
		echo_title "Stopping ZeroTier-One"
		killall -q -9 $DAEMON && \
			sleep 2 && \
			rmmod tun && \
			play /usr/share/sounds/zerotiervpnisdown.opus
		;;
	*)
		echo_error "Unknown action $action"
		echo "Usage: $0 {start|stop}"
		exit 1
		;;
esac

exit 0
