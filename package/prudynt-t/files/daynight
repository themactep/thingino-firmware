#!/bin/sh

. /usr/share/common

singleton $0

MODE_FILE="/run/prudynt/daynight_mode"
PRUDYNT_CONFIG="/etc/prudynt.json"

command_present() {
	command -v "$1" >/dev/null 2>&1
}

get_value() {
	jct "$PRUDYNT_CONFIG" get "daynight.controls.$1" 2>/dev/null || \
		echo "true"
}

# Load control flags from prudynt config
load_controls() {
	if command_present jct && [ -f "$PRUDYNT_CONFIG" ]; then
		day_night_color=$(get_value color)
		day_night_ircut=$(get_value ircut)
		day_night_ir850=$(get_value ir850)
		day_night_ir940=$(get_value ir940)
		day_night_white=$(get_value white)
	else
		# Fallback defaults
		day_night_color="true"
		day_night_ircut="true"
		day_night_ir850="true"
		day_night_ir940="true"
		day_night_white="false"
	fi
}

switch_to_day() {
	echo_info "Switching to day mode..."
	load_controls

	if [ "true" = "$day_night_ircut" ] && command_present ircut; then
		echo_info "  set IR-CUT filter"
		ircut on &
	fi

	if [ "true" = "$day_night_ir850" ] && [ -n "$gpio_ir850" ] && command_present light; then
		echo_info "  turn IR LED 850nm OFF"
		light ir850 off &
	fi

	if [ "true" = "$day_night_ir940" ] && [ -n "$gpio_ir940" ] && command_present light; then
		echo_info "  turn IR LED 940nm OFF"
		light ir940 off &
	fi

	if [ "true" = "$day_night_white" ] && [ -n "$gpio_white" ] && command_present light; then
		echo_info "  turn White Light OFF"
		light white off &
	fi

	if [ "true" = "$day_night_color" ] && command_present color; then
		echo_info "  switch to color mode"
		color on &
	fi
}

switch_to_night() {
	echo_info "Switching to night mode..."
	load_controls

	if [ "true" = "$day_night_color" ] && command_present color; then
		echo_info "  switch to monochrome mode"
		color off &
	fi

	if [ "true" = "$day_night_ircut" ] && command_present ircut; then
		echo_info "  remove IR-CUT filter"
		ircut off &
	fi

	if [ "true" = "$day_night_ir850" ] && [ -n "$gpio_ir850" ] && command_present light; then
		echo_info "  turn IR LED 850nm ON"
		light ir850 on &
	fi

	if [ "true" = "$day_night_ir940" ] && [ -n "$gpio_ir940" ] && command_present light; then
		echo_info "  turn IR LED 940nm ON"
		light ir940 on &
	fi

	if [ "true" = "$day_night_white" ] && [ -n "$gpio_white" ] && command_present light; then
		echo_info "  turn White Light ON"
		light white on &
	fi
}

state=$(awk 'NR==1 {print $1}' "$MODE_FILE" 2>/dev/null || echo "day")

case "$1" in
	night)
		switch_to_night
		;;
	day)
		switch_to_day
		;;
	~ | toggle)
		if [ "day" = "$state" ]; then
			switch_to_night
		else
			switch_to_day
		fi
		;;
	\? | read | status)
		echo "$state"
		;;
	*)
		echo_info "Usage: $0 {day|night|toggle|read}"
		echo_info "Current state: $state"
		;;
esac

exit 0
