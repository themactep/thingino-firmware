#!/bin/sh
# Triggered on a motion event

. /usr/share/common

singleton "$0"

MOTION_ALARM="/run/motion/motion_alarm"
MOTION_ALARM_DIR=$(dirname "$MOTION_ALARM")
[ -d "$MOTION_ALARM_DIR" ] || mkdir -p "$MOTION_ALARM_DIR"

MOTION_STOP_FILE="/run/motors.pid"

MOTION_VIDEO_CHANNEL=0
MOTION_VIDEO_LENGTH=10

domain=motion

get_value() {
        jct /etc/prudynt.json get "motion.$1" 2>/dev/null
}

start() {
	echo_info "Start motion"
	if [ -f "$MOTION_STOP_FILE" ]; then
		echo_error "Motor motion file present. Exiting."
		exit 1
	fi

	# Generate timestamp for this motion event
	MOTION_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
	MOTION_PHOTO_FILE="/tmp/motion_${MOTION_TIMESTAMP}.jpg"
	MOTION_VIDEO_FILE="/tmp/motion_${MOTION_TIMESTAMP}.mp4"

	echo_info "Set $MOTION_ALARM"
	touch "$MOTION_ALARM"

	# Check if any send2* service needs photo or video
	need_photo=false
	need_video=false

	for service in email ftp gphotos mqtt ntfy storage telegram webhook; do
		if [ "true" = "$(get_value send2${service})" ]; then
			[ "true" = "$(jct /etc/send2.json get ${service}.send_photo 2>/dev/null)" ] && need_photo=true
			[ "true" = "$(jct /etc/send2.json get ${service}.send_video 2>/dev/null)" ] && need_video=true
		fi
	done

	# Capture snapshot only if needed
	if [ "$need_photo" = "true" ]; then
		echo_info "Capture snapshot $MOTION_PHOTO_FILE"
		prudyntctl snapshot -c $MOTION_VIDEO_CHANNEL > "$MOTION_PHOTO_FILE"
		export MOTION_PHOTO_FILE
	else
		echo_info "Skipping snapshot (not needed by any send2 service)"
		unset MOTION_PHOTO_FILE
	fi

	# Record video only if needed
	if [ "$need_video" = "true" ]; then
		echo_info "Start recording $MOTION_VIDEO_FILE"
		echo "START $MOTION_VIDEO_FILE $MOTION_VIDEO_LENGTH $MOTION_VIDEO_CHANNEL" > /run/prudynt/mp4ctl

		# Wait for video file to be created and finish recording
		sleep 2
		while [ ! -f "$MOTION_VIDEO_FILE" ]; do
			sleep 1
		done

		# Wait for file to finish writing (size stops changing)
		prev_size=0
		curr_size=$(stat -c%s "$MOTION_VIDEO_FILE" 2>/dev/null || echo 0)
		stable_count=0
		max_wait=0

		while [ $stable_count -lt 2 ] && [ $max_wait -lt 15 ]; do
			sleep 1
			prev_size=$curr_size
			curr_size=$(stat -c%s "$MOTION_VIDEO_FILE" 2>/dev/null || echo 0)

			if [ "$curr_size" -eq "$prev_size" ] && [ "$curr_size" -gt 0 ]; then
				stable_count=$((stable_count + 1))
			else
				stable_count=0
			fi
			max_wait=$((max_wait + 1))
		done

		echo_info "Motion video is ready."
		export MOTION_VIDEO_FILE
	else
		echo_info "Skipping video recording (not needed by any send2 service)"
		unset MOTION_VIDEO_FILE
	fi

	# send2 actions
	send2_pids=""

	if [ "true" = "$(get_value send2email)" ]; then
		echo_info "Send alert to email"
		MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2email &
		send2_pids="$send2_pids $!"
	fi

	if [ "true" = "$(get_value send2ftp)" ]; then
		echo_info "Send alert to FTP"
		MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2ftp &
		send2_pids="$send2_pids $!"
	fi

	if [ "true" = "$(get_value send2mqtt)" ]; then
		echo_info "Send alert to MQTT"
		MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2mqtt &
		send2_pids="$send2_pids $!"
	fi

	if [ "true" = "$(get_value send2ntfy)" ]; then
		echo_info "Send alert to Ntfy"
		MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2ntfy &
		send2_pids="$send2_pids $!"
	fi

	if [ "true" = "$(get_value send2storage)" ]; then
		echo_info "Save to storage"
		MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2storage &
		send2_pids="$send2_pids $!"
	fi

	if [ "true" = "$(get_value send2gphotos)" ]; then
		echo_info "Upload to Google Photos"
		MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2gphotos &
		send2_pids="$send2_pids $!"
	fi

	if [ "true" = "$(get_value send2telegram)" ]; then
		echo_info "Send alert to Telegram"
		if [ "$need_photo" = "true" ] || [ "$need_video" = "true" ]; then
			echo_info "MOTION_PHOTO_FILE=$MOTION_PHOTO_FILE MOTION_VIDEO_FILE=$MOTION_VIDEO_FILE"
			MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2telegram -v >>/tmp/send2telegram.log 2>&1 &
			send2_pids="$send2_pids $!"
		else
			echo_info "Skipping Telegram (no media to send)"
		fi
	fi

	if [ "true" = "$(get_value send2webhook)" ]; then
		echo_info "Send alert to WebHook"
		MOTION_PHOTO_FILE="$MOTION_PHOTO_FILE" MOTION_VIDEO_FILE="$MOTION_VIDEO_FILE" send2webhook &
		send2_pids="$send2_pids $!"
	fi

	if [ "true" = "$(get_value playonspeaker)" ]; then
		echo_info "Send alert to play on speaker"
		playonspeaker &
		send2_pids="$send2_pids $!"
	fi

	# Wait for all send2 processes to complete in background, then cleanup
	if [ -n "$send2_pids" ]; then
		(
			# Wait for each send2 process to complete
			for pid in $send2_pids; do
				# Use kill -0 to check if process exists, then wait
				while kill -0 $pid 2>/dev/null; do
					sleep 1
				done
			done
			echo_info "Cleaning up motion files"
			[ -f "$MOTION_PHOTO_FILE" ] && rm -f "$MOTION_PHOTO_FILE"
			[ -f "$MOTION_VIDEO_FILE" ] && rm -f "$MOTION_VIDEO_FILE"
		) &
	fi
}

stop() {
	echo_info "Stop motion"

	if [ -f "$MOTION_ALARM" ]; then
		echo_info "Remove $MOTION_ALARM"
		rm -f "$MOTION_ALARM"
	fi
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	*)
		start
		;;
esac

exit 0
