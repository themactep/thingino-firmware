#!/bin/env sh

. /usr/share/common
. /usr/share/send2common

domain="ftp"
config_file="/etc/send2.json"

show_help() {
	echo "Usage: $0 [options]
Where:
	-h host      FTP server FQDN or IP address
	-p port      FTP server port
	-u username  FTP username
	-P password  FTP password
	-d path      Directory relative to FTP root
	-f file      File to upload
	-v           Verbose output
	-S           Send photo
	-V           Send video
" >&2
	exit 0
}

read_config() {
	[ -f "$config_file" ] || return

	host=$(get_value host)
	path=$(get_value path)
	password=$(get_value password)
	port=$(get_value port)
	template=$(get_value template)
	username=$(get_value username)
}

# Files to send
queue=""

add_to_queue() {
	queue="$queue $1"
}

# rename file by the template
process_file() {
	local file="$1"
	local ext="${file##*.}"
	local name="/tmp/$(date +"$template").$ext"
	mv "$file" "$name"
	add_to_queue "$name"
	add_to_garbage "$name"
}

read_config

# order is important!
while getopts d:h:p:u:vP:f:SV flag; do
	case "$flag" in
		d) path=$OPTARG ;;
		h) host=$OPTARG ;;
		p) port=$OPTARG ;;
		u) username=$OPTARG ;;
		v) verbose="true" ;;
		P) password=$OPTARG ;;
		# sending a file from the command line disables sending photo
		# and video defined in config unless explicitly set so (-S/-V)
		f) file=$OPTARG; send_photo="false"; send_video="false" ;;
		S) send_photo="true" ;;
		V) send_video="true" ;;
		*) show_help ;;
	esac
done

# use config settings only if not set from command line
if [ -z "$send_photo$send_video" ]; then
        send_photo=$(get_value send_photo)
        send_video=$(get_value send_video)
fi

if [ -z "$host" ]; then
	echo_error "FTP host not found"
	exit 1
fi

[ -z "$port" ] && port=21
[ -z "$username" ] && username="anonymous" && password="anonymous"

if [ -n "$file" ]; then
	add_to_queue "$file"
fi

if [ "true" = "$send_video" ]; then
	process_file $(copy_video)
fi

if [ "true" = "$send_photo" ]; then
	process_file $(copy_photo)
fi

url="ftp://"
[ -n "$username" ] && [ -n "$password" ] && url="$url$username:$password"
url="$url@$host:$port"
if [ -n "$path" ]; then
	path="$(date +"$path")"
	url="$url/${path// /%20}"
fi

for local_file in $queue; do
	if [ "true" = "$verbose" ]; then
		command="$CURL --verbose"
	else
		command="$CURL --silent"
	fi
	command="$command --url $url/$(basename $local_file) --upload-file $local_file --ftp-create-dirs"

	[ "true" = "$verbose" ] && echo_command "$command"

	if ! sh -c "$command"; then
		echo_error "Failed to upload file to FTP server"
		exit 1
	fi
done

exit 0
