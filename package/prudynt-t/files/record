#!/bin/sh

. /usr/share/common

STREAMER_APP="prudynt"
FIFO_PATH="/run/prudynt/mp4ctl"
PRUDYNT_CONFIG="/etc/prudynt.json"
LEGACY_RECORDER_CONFIG="/etc/recorder.json"

json_get() {
	local file="$1"
	local key="$2"
	[ -f "$file" ] || return
	jct "$file" get "$key" 2>/dev/null | tr -d '"' || true
}

expand_template() {
	local value="$1"
	local host_short
	host_short=$(hostname -s 2>/dev/null || hostname 2>/dev/null || echo "thingino")
	value=${value//%hostname/$host_short}
	printf '%s' "$value"
}

read_config() {
	mount=$(json_get "$PRUDYNT_CONFIG" recorder.mount)
	device_path=$(json_get "$PRUDYNT_CONFIG" recorder.device_path)
	filename=$(json_get "$PRUDYNT_CONFIG" recorder.filename)
	duration=$(json_get "$PRUDYNT_CONFIG" recorder.duration)
	stream_number=$(json_get "$PRUDYNT_CONFIG" recorder.channel)

	if [ -f "$LEGACY_RECORDER_CONFIG" ]; then
		[ -z "$mount" ] && mount=$(json_get "$LEGACY_RECORDER_CONFIG" mount)
		[ -z "$device_path" ] && device_path=$(json_get "$LEGACY_RECORDER_CONFIG" device_path)
		[ -z "$filename" ] && filename=$(json_get "$LEGACY_RECORDER_CONFIG" filename)
		[ -z "$duration" ] && duration=$(json_get "$LEGACY_RECORDER_CONFIG" duration)
	fi
}

wait_for_active_creation() {
	local file="$1"
	local timeout="${2:-10}"
	while [ "$timeout" -gt 0 ]; do
		[ -f "$file" ] && return 0
		sleep 1
		timeout=$((timeout - 1))
	done
	return 1
}

wait_for_active_completion() {
	local file="$1"
	while [ -f "$file" ]; do
		sleep 1
	done
}

read_config

while getopts "c:d:m:n:s:t:x" flag; do
	case "$flag" in
		c) stream_number=$OPTARG ;;
		d) : ;; # deprecated placeholder
		m) mount=$OPTARG ;;
		n) filename=$OPTARG ;;
		s) device_path=$OPTARG ;;
		t) duration=$OPTARG ;;
		x) one_time="true" ;;
		*)
			echo "Usage: $0 [-c chan] [-t seconds] [-m mount] [-s dir] [-n template] [-x]" >&2
			exit 1
			;;
	esac
done
shift "$((OPTIND - 1))"

device_path=$(expand_template "$device_path")

if ! pidof "$STREAMER_APP" >/dev/null 2>&1; then
	echo_error "Streamer is not running"
	exit 1
fi

[ -z "$mount" ] && mount="/mnt/mmc"
[ -z "$filename" ] && filename="%Y/%m/%d/%H-%M-%S"
[ -z "$duration" ] && duration=60
[ -z "$stream_number" ] && stream_number=0

if ! echo "$duration" | grep -Eq '^[0-9]+$' || [ "$duration" -le 0 ]; then
	echo_error "Duration must be a positive integer"
	exit 1
fi

case "$stream_number" in
	0|1)
		;;
	*)
		echo_error "Invalid stream number: $stream_number"
		exit 1
		;;
esac

mount=${mount%/}
device_path=${device_path#/}
device_path=${device_path%/}

[ -z "$mount" ] && {
	echo_error "Mountpoint is not set"
	exit 1
}

if [ ! -d "$mount" ] || ! mountpoint -q "$mount" 2>/dev/null; then
	echo_error "Mountpoint $mount is not available"
	exit 1
fi

ACTIVE_FILE="/run/prudynt/mp4ctl-ch${stream_number}.active"

if [ "$one_time" = "true" ]; then
	base_path="$mount"
	[ -n "$device_path" ] && base_path="$base_path/$device_path"
	file_path="$base_path/$(date +"$filename")"
	case "$file_path" in
		*.mp4) : ;;
		*) file_path="$file_path.mp4" ;;
	esac
	ensure_dir "$(dirname "$file_path")"
	printf 'START path=%s dur=%s ch=%s\n' "$file_path" "$duration" "$stream_number" > "$FIFO_PATH"
	if wait_for_active_creation "$ACTIVE_FILE" 10; then
		wait_for_active_completion "$ACTIVE_FILE"
	else
		echo_warning "Recorder did not create $ACTIVE_FILE; clip may have failed"
	fi
else
	printf 'START mount=%s dir=%s name=%s dur=%s ch=%s loop=1\n' \
		"$mount" "${device_path}" "$filename" "$duration" "$stream_number" > "$FIFO_PATH"
fi

[ -n "$LEDD_FLAG" ] && [ -f "$LEDD_FLAG" ] && rm -f "$LEDD_FLAG"

exit 0
