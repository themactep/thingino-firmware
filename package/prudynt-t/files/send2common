GARBAGE=""
GARBAGE_FILE="$(mktemp "${TMPDIR:-/tmp}/send2_garbage.XXXXXX")" || {
	echo "send2: unable to create garbage tracker" >&2
	exit 1
}
export GARBAGE_FILE

add_to_garbage() {
	[ -n "$1" ] || return
	GARBAGE="${GARBAGE:+$GARBAGE }$1"
	[ -n "$GARBAGE_FILE" ] && printf '%s\n' "$1" >> "$GARBAGE_FILE"
}

_cleanup() {
	if [ -n "$GARBAGE_FILE" ] && [ -f "$GARBAGE_FILE" ]; then
		while IFS= read -r garbage_path; do
			[ -n "$garbage_path" ] && rm -f -- "$garbage_path"
		done < "$GARBAGE_FILE"
		rm -f -- "$GARBAGE_FILE"
	fi
	GARBAGE=""
}

copy_photo() {
	# Use existing photo from motion if available
	if [ -n "$MOTION_PHOTO_FILE" ] && [ -f "$MOTION_PHOTO_FILE" ]; then
		# Copy to temp file immediately to avoid race condition with cleanup
		local tmpfile="$(mktemp -u).jpg"
		cp "$MOTION_PHOTO_FILE" "$tmpfile"
		add_to_garbage "$tmpfile"
		echo "$tmpfile"
		return
	fi

	local tmpfile="$(mktemp -u).jpg"
	prudyntctl snapshot -c 0 > "$tmpfile"
	add_to_garbage "$tmpfile"
	echo "$tmpfile"
}

copy_video() {
	# Use existing video from motion if available
	if [ -n "$MOTION_VIDEO_FILE" ] && [ -f "$MOTION_VIDEO_FILE" ]; then
		# Copy to temp file immediately to avoid race condition with cleanup
		local tmpfile="$(mktemp -u).mp4"
		cp "$MOTION_VIDEO_FILE" "$tmpfile"
		add_to_garbage "$tmpfile"
		echo "$tmpfile"
		return
	fi

	local tmpfile="$(mktemp -u).mp4"

	# Check if mp4ctl interface exists
	if [ ! -e "/run/prudynt/mp4ctl" ]; then
		echo "$tmpfile"
		return 1
	fi

	# Send recording command
	if ! echo "START $tmpfile 10 0" > /run/prudynt/mp4ctl 2>/dev/null; then
		echo "$tmpfile"
		return 1
	fi

	# Wait for file to be created (max 15 seconds)
	local i=0
	while [ ! -f "$tmpfile" ] && [ $i -lt 15 ]; do
		sleep 1
		i=$((i + 1))
	done

	if [ ! -f "$tmpfile" ]; then
		echo "$tmpfile"
		return 1
	fi

	# Wait for file to finish writing (size stops changing)
	local prev_size=0
	local curr_size=$(stat -c%s "$tmpfile" 2>/dev/null || echo 0)
	local stable_count=0

	# Wait until size is stable for 2 consecutive checks or max 20 iterations
	i=0
	while [ $stable_count -lt 2 ] && [ $i -lt 20 ]; do
		sleep 1
		prev_size=$curr_size
		curr_size=$(stat -c%s "$tmpfile" 2>/dev/null || echo 0)

		if [ "$curr_size" -eq "$prev_size" ] && [ "$curr_size" -gt 0 ]; then
			stable_count=$((stable_count + 1))
		else
			stable_count=0
		fi
		i=$((i + 1))
	done

	add_to_garbage "$tmpfile"
	echo "$tmpfile"
}

get_value() {
	jct "$config_file" get "$domain.$1" 2>/dev/null
}

trap _cleanup EXIT
