#!/bin/env sh

. /usr/share/common
. /usr/share/send2common

domain="storage"
config_file="/etc/send2.json"

show_help() {
	echo "Usage: $0 [options]
Where:
	-m mount      Mount point (e.g., /mnt/mmc, /mnt/nfs)
	-d path       Device-specific path within mount
	-t template   Filename template (strftime format)
	-S            Send photo
	-V            Send video
	-v            Verbose output
" >&2
	exit 0
}

read_config() {
	[ -f "$config_file" ] || return

	mount=$(get_value mount)
	device_path=$(get_value device_path)
	template=$(get_value template)
}

# Files to send
queue=""

add_to_queue() {
	queue="$queue $1"
}

# rename file by the template
process_file() {
	local file="$1"
	local ext="${file##*.}"
	local name="/tmp/$(date +"$template").$ext"
	mv "$file" "$name"
	add_to_queue "$name"
	# Don't add to garbage since we're keeping it
}

read_config

# order is important!
while getopts m:d:t:vSV flag; do
	case "$flag" in
		m) mount=$OPTARG ;;
		d) device_path=$OPTARG ;;
		t) template=$OPTARG ;;
		v) verbose="true" ;;
		S) send_photo="true" ;;
		V) send_video="true" ;;
		*) show_help ;;
	esac
done

# use config settings only if not set from command line
if [ -z "$send_photo$send_video" ]; then
        send_photo=$(get_value send_photo)
        send_video=$(get_value send_video)
fi

# Validate mount point
if [ -z "$mount" ]; then
	echo_error "Mount point not configured"
	exit 1
fi

if [ ! -d "$mount" ]; then
	echo_error "Mount point does not exist: $mount"
	exit 1
fi

# Check if mount is writable
if ! touch "$mount/.write_test" 2>/dev/null; then
	echo_error "Mount point is not writable: $mount"
	exit 1
fi
rm -f "$mount/.write_test"

# Set defaults
[ -z "$template" ] && template="$(hostname -s)-%Y%m%d-%H%M%S"

# Create destination directory
dest_dir="$mount"
[ -n "$device_path" ] && dest_dir="$dest_dir/$device_path"

if [ ! -d "$dest_dir" ]; then
	mkdir -p "$dest_dir" || {
		echo_error "Failed to create directory: $dest_dir"
		exit 1
	}
fi

# Process media files
if [ "true" = "$send_video" ]; then
	process_file $(copy_video)
fi

if [ "true" = "$send_photo" ]; then
	process_file $(copy_photo)
fi

# Copy files to storage
for local_file in $queue; do
	dest_file="$dest_dir/$(basename $local_file)"

	[ "true" = "$verbose" ] && echo_info "Copying $local_file to $dest_file"

	if ! cp "$local_file" "$dest_file"; then
		echo_error "Failed to copy file to storage: $dest_file"
		rm -f "$local_file"
		exit 1
	fi

	# Clean up temp file after successful copy
	rm -f "$local_file"
done

[ "true" = "$verbose" ] && echo_info "Successfully saved files to $dest_dir"

exit 0
