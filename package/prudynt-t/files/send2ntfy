#!/bin/env sh
# Sends data to ntfy.sh
# https://docs.ntfy.sh/publish/

. /usr/share/common
. /usr/share/send2common

show_help() {
	echo "Usage: $0 [options]
Where:
	-a URL       Attachment URL.
	-c URL       Click URL.
	-f file      Attach file.
	-h host      Server host.
	-i URL       Icon URL.
	-m message   Message body.
	-n title     Message title.
	-p N         Priority. 1-lowest, 5-highest.
	-s           Send a snapshot.
	-t topic     Topic.
	-u username  Username.
	-w password  Password.
	-v           Verbose output.
" >&2
	exit 0
}

read_config() {
	local CONFIG_FILE=/etc/send2.json
	[ -f "$CONFIG_FILE" ] || return

	       host=$(jct $CONFIG_FILE get ntfy.host || echo "ntfy.sh")
               port=$(jct $CONFIG_FILE get ntfy.port || echo "80")
           username=$(jct $CONFIG_FILE get ntfy.username)
           password=$(jct $CONFIG_FILE get ntfy.password)
	      token=$(jct $CONFIG_FILE get ntfy.token)
              topic=$(jct $CONFIG_FILE get ntfy.topic)
               icon=$(jct $CONFIG_FILE get ntfy.icon || echo "")
            message=$(jct $CONFIG_FILE get ntfy.message)
	      title=$(jct $CONFIG_FILE get ntfy.title)
	       tags=$(jct $CONFIG_FILE get ntfy.tags || echo "[]")
	      delay=$(jct $CONFIG_FILE get ntfy.delay || echo "")
            prority=$(jct $CONFIG_FILE get ntfy.priority || echo "")
         send_photo=$(jct $CONFIG_FILE get ntfy.send_photo)
	     attach=$(jct $CONFIG_FILE get ntfy.attach || echo "")
              click=$(jct $CONFIG_FILE get ntfy.click || echo "")
	   filename=$(jct $CONFIG_FILE get ntfy.filename || echo "")
	      email=$(jct $CONFIG_FILE get ntfy.email || echo "")
	       call=$(jct $CONFIG_FILE get ntfy.call || echo "")
	    actions=$(jct $CONFIG_FILE get ntfy.actions || echo "")
       twilio_token=$(jct $CONFIG_FILE get ntfy.twilio_token || echo "")
}

read_config

while getopts a:c:f:h:i:l:m:n:p:st:u:w:v flag; do
	case "$flag" in
		a) attach=$OPTARG ;;
		c) click=$OPTARG ;;
		f) filename=$OPTARG ;;
		h) host=$OPTARG ;;
		i) icon=$OPTARG ;;
		m) message=$OPTARG ;;
		n) title=$OPTARG ;;
		p) priority=$OPTARG ;;
		s) send_photo="true" ;;
		t) topic=$OPTARG ;;
		u) username=$OPTARG ;;
		w) password=$OPTARG ;;
		v) verbose="true" ;;
		*) show_help ;;
	esac
done

[ -z "$host" ] && host="ntfy.sh"
[ -z "$port" ] && port=80

if [ -z "$topic" ]; then
	echo_error "NTFY topic is not set"
	exit 1
fi

command="curl -X POST -H p:${priority:-3}"

if [ "true" = "$verbose" ]; then
	command="$command --verbose"
else
	command="$command --silent"
fi

[ -n "$title" ] && command="$command -H 'Title: $title'"
[ -n "$tags" ] && command="$command -H 'Tags: $tags'"
[ -n "$delay" ] && command="$command -H 'Delay: $delay'"

if [ -n "$token" ]; then
	command="$command -H 'Authorization: Bearer $token'"
elif [ -n "$username" ] && [ -n "$password" ]; then
	command="$command -u $username:$password"
fi

if [ "true" = "$send_photo" ]; then
	photo=$(copy_photo)
	command="$command -T $photo -H 'Filename: $photo'"
fi

if [ -n "$filename" ] && [ -f "$filename" ]; then
	command="$command -T $filename -H 'Filename: $filename'"
fi

[ -n "$attach" ] && command="$command -H 'Attach: $attach'"
[ -n "$click" ] && command="$command -H 'Click: $click'"
[ -n "$icon" ] && command="$command -H 'Icon: $icon'"
[ -n "$email" ] && command="$command -H 'Email: $email'"
[ -n "$actions" ] && command="$command -H 'Actions: $actions'"

if [ -n "$call" ] && [ -n "$twilio_token" ]; then
	command="$command -H 'Call: $call' -u :$twilio_token"
fi

if [ -n "$message" ]; then
	message="$(date +"$message")"
	command="$command -H 'Message: $message'"
fi

command="$command $host/$topic"

if [ "true" = "$verbose" ]; then
	echo_command "$command"
fi

if ! sh -c "$command" >/dev/null; then
	echo_error "Failed to send NTFY message"
	exit 1
fi

exit 0
