diff --git a/config.h b/config.h
index b25bea31..eec3f481 100644
--- a/config.h
+++ b/config.h
@@ -56,9 +56,13 @@
 
 
 #ifdef WITH_TLS
-#  include <openssl/opensslconf.h>
-#  if defined(WITH_TLS_PSK) && !defined(OPENSSL_NO_PSK)
-#    define FINAL_WITH_TLS_PSK
+#  if defined(WITH_TLS_MBEDTLS)
+#    include <mbedtls/version.h>
+#  elif defined(WITH_TLS_OPENSSL)
+#    include <openssl/opensslconf.h>
+#    if defined(WITH_TLS_PSK) && !defined(OPENSSL_NO_PSK)
+#      define FINAL_WITH_TLS_PSK
+#    endif
 #  endif
 #endif
 
diff --git a/config.mk b/config.mk
index 34d5163f..97fe2025 100644
--- a/config.mk
+++ b/config.mk
@@ -28,6 +28,10 @@ WITH_TLS:=yes
 # This must be disabled if using openssl < 1.0.
 WITH_TLS_PSK:=yes
 
+# Select TLS backend. Supported values: openssl (default), mbedtls.
+TLS_IMPL?=openssl
+TLS_IMPL:=$(strip $(TLS_IMPL))
+
 # Comment out to disable client threading support.
 WITH_THREADING:=yes
 
@@ -185,7 +189,7 @@ BROKER_LDADD:=
 CLIENT_CPPFLAGS:=$(CPPFLAGS) -I.. -I../include
 CLIENT_CFLAGS:=${CFLAGS} -DVERSION="\"${VERSION}\""
 CLIENT_LDFLAGS:=$(LDFLAGS) -L../lib
-CLIENT_LDADD:=
+CLIENT_LDADD:=$(CLIENT_LDADD) -lmosquitto
 
 PASSWD_LDADD:=
 
@@ -208,9 +212,9 @@ ifeq ($(UNAME),Linux)
 	LIB_LIBADD:=$(LIB_LIBADD) -lrt
 endif
 
-ifeq ($(WITH_SHARED_LIBRARIES),yes)
-	CLIENT_LDADD:=${CLIENT_LDADD} ../lib/libmosquitto.so.${SOVERSION}
-endif
+	ifneq ($(TLS_IMPL),mbedtls)
+		# this block was corrupted; restore structure before handling TLS_IMPL
+	endif
 
 ifeq ($(UNAME),SunOS)
 	SEDINPLACE:=
@@ -250,19 +254,42 @@ ifeq ($(WITH_WRAP),yes)
 endif
 
 ifeq ($(WITH_TLS),yes)
-	APP_CPPFLAGS:=$(APP_CPPFLAGS) -DWITH_TLS -DOPENSSL_API_COMPAT=0x10100000L
-	BROKER_CPPFLAGS:=$(BROKER_CPPFLAGS) -DWITH_TLS -DOPENSSL_API_COMPAT=0x10100000L
-	BROKER_LDADD:=$(BROKER_LDADD) -lssl -lcrypto
-	CLIENT_CPPFLAGS:=$(CLIENT_CPPFLAGS) -DWITH_TLS -DOPENSSL_API_COMPAT=0x10100000L
-	LIB_CPPFLAGS:=$(LIB_CPPFLAGS) -DWITH_TLS -DOPENSSL_API_COMPAT=0x10100000L
-	LIB_LIBADD:=$(LIB_LIBADD) -lssl -lcrypto
+	APP_CPPFLAGS:=$(APP_CPPFLAGS) -DWITH_TLS
+	BROKER_CPPFLAGS:=$(BROKER_CPPFLAGS) -DWITH_TLS
+	CLIENT_CPPFLAGS:=$(CLIENT_CPPFLAGS) -DWITH_TLS
+	LIB_CPPFLAGS:=$(LIB_CPPFLAGS) -DWITH_TLS
+
+	ifeq ($(TLS_IMPL),mbedtls)
+		APP_CPPFLAGS:=$(APP_CPPFLAGS) -DWITH_TLS_MBEDTLS
+		BROKER_CPPFLAGS:=$(BROKER_CPPFLAGS) -DWITH_TLS_MBEDTLS
+		CLIENT_CPPFLAGS:=$(CLIENT_CPPFLAGS) -DWITH_TLS_MBEDTLS
+		LIB_CPPFLAGS:=$(LIB_CPPFLAGS) -DWITH_TLS_MBEDTLS
+		MOSQ_TLS_LIBS:=-lmbedtls -lmbedx509 -lmbedcrypto
+		BROKER_LDADD:=$(BROKER_LDADD) $(MOSQ_TLS_LIBS)
+		CLIENT_LDADD:=$(CLIENT_LDADD) $(MOSQ_TLS_LIBS)
+		LIB_LIBADD:=$(LIB_LIBADD) $(MOSQ_TLS_LIBS)
+		STATIC_LIB_DEPS:=$(STATIC_LIB_DEPS) $(MOSQ_TLS_LIBS)
+	else
+		APP_CPPFLAGS:=$(APP_CPPFLAGS) -DWITH_TLS_OPENSSL -DOPENSSL_API_COMPAT=0x10100000L
+		BROKER_CPPFLAGS:=$(BROKER_CPPFLAGS) -DWITH_TLS_OPENSSL -DOPENSSL_API_COMPAT=0x10100000L
+		CLIENT_CPPFLAGS:=$(CLIENT_CPPFLAGS) -DWITH_TLS_OPENSSL -DOPENSSL_API_COMPAT=0x10100000L
+		LIB_CPPFLAGS:=$(LIB_CPPFLAGS) -DWITH_TLS_OPENSSL -DOPENSSL_API_COMPAT=0x10100000L
+		BROKER_LDADD:=$(BROKER_LDADD) -lssl -lcrypto
+		CLIENT_LDADD:=$(CLIENT_LDADD) -lssl -lcrypto
+		LIB_LIBADD:=$(LIB_LIBADD) -lssl -lcrypto
+		STATIC_LIB_DEPS:=$(STATIC_LIB_DEPS) -lssl -lcrypto
+	endif
+
 	PASSWD_LDADD:=$(PASSWD_LDADD) -lcrypto
-	STATIC_LIB_DEPS:=$(STATIC_LIB_DEPS) -lssl -lcrypto
 
 	ifeq ($(WITH_TLS_PSK),yes)
-		BROKER_CPPFLAGS:=$(BROKER_CPPFLAGS) -DWITH_TLS_PSK
-		LIB_CPPFLAGS:=$(LIB_CPPFLAGS) -DWITH_TLS_PSK
-		CLIENT_CPPFLAGS:=$(CLIENT_CPPFLAGS) -DWITH_TLS_PSK
+		ifeq ($(TLS_IMPL),mbedtls)
+                $(warning TLS PSK mode currently requires the OpenSSL backend; disabling PSK support)
+		else
+			BROKER_CPPFLAGS:=$(BROKER_CPPFLAGS) -DWITH_TLS_PSK
+			LIB_CPPFLAGS:=$(LIB_CPPFLAGS) -DWITH_TLS_PSK
+			CLIENT_CPPFLAGS:=$(CLIENT_CPPFLAGS) -DWITH_TLS_PSK
+		endif
 	endif
 endif
 
diff --git a/lib/Makefile b/lib/Makefile
index 878698ef..948abca9 100644
--- a/lib/Makefile
+++ b/lib/Makefile
@@ -22,7 +22,6 @@ MOSQ_OBJS=mosquitto.o \
 		  memory_mosq.o \
 		  messages_mosq.o \
 		  misc_mosq.o \
-		  net_mosq_ocsp.o \
 		  net_mosq.o \
 		  options.o \
 		  packet_datatypes.o \
@@ -40,12 +39,18 @@ MOSQ_OBJS=mosquitto.o \
 		  strings_mosq.o \
 		  thread_mosq.o \
 		  time_mosq.o \
-		  tls_mosq.o \
 		  utf8_mosq.o \
 		  util_mosq.o \
 		  util_topic.o \
 		  will_mosq.o
 
+ifeq ($(TLS_IMPL),openssl)
+MOSQ_OBJS+=net_mosq_ocsp.o \
+		tls_mosq.o
+else ifeq ($(TLS_IMPL),mbedtls)
+MOSQ_OBJS+=tls_mbedtls.o
+endif
+
 ALL_DEPS:=
 
 ifeq ($(WITH_SHARED_LIBRARIES),yes)
@@ -94,6 +99,7 @@ clean :
 
 libmosquitto.so.${SOVERSION} : ${MOSQ_OBJS}
 	${CROSS_COMPILE}$(CC) -shared $(LIB_LDFLAGS) $^ -o $@ ${LIB_LIBADD}
+	ln -sf $@ libmosquitto.so
 
 libmosquitto.a : ${MOSQ_OBJS}
 	${CROSS_COMPILE}$(AR) cr $@ $^
@@ -215,6 +221,9 @@ time_mosq.o : time_mosq.c
 tls_mosq.o : tls_mosq.c
 	${CROSS_COMPILE}$(CC) $(LIB_CPPFLAGS) $(LIB_CFLAGS) -c $< -o $@
 
+tls_mbedtls.o : tls_mbedtls.c tls_mbedtls.h
+	${CROSS_COMPILE}$(CC) $(LIB_CPPFLAGS) $(LIB_CFLAGS) -c $< -o $@
+
 utf8_mosq.o : utf8_mosq.c
 	${CROSS_COMPILE}$(CC) $(LIB_CPPFLAGS) $(LIB_CFLAGS) -c $< -o $@
 
diff --git a/lib/loop.c b/lib/loop.c
index 215982cd..0a76eb1b 100644
--- a/lib/loop.c
+++ b/lib/loop.c
@@ -66,7 +66,7 @@ int mosquitto_loop(struct mosquitto *mosq, int timeout, int max_packets)
 		if(mosq->want_write){
 			FD_SET(mosq->sock, &writefds);
 		}else{
-#ifdef WITH_TLS
+#if defined(WITH_TLS_OPENSSL)
 			if(mosq->ssl == NULL || SSL_is_init_finished(mosq->ssl))
 #endif
 			{
diff --git a/lib/mosquitto.c b/lib/mosquitto.c
index 84e10c7f..0fb91386 100644
--- a/lib/mosquitto.c
+++ b/lib/mosquitto.c
@@ -199,7 +199,8 @@ int mosquitto_reinitialise(struct mosquitto *mosq, const char *id, bool clean_st
 	mosq->reconnect_delay_max = 1;
 	mosq->reconnect_exponential_backoff = false;
 	mosq->threaded = mosq_ts_none;
-#ifdef WITH_TLS
+	mosq->want_write = false;
+#ifdef WITH_TLS_OPENSSL
 	mosq->ssl = NULL;
 	mosq->ssl_ctx = NULL;
 	mosq->ssl_ctx_defaults = true;
@@ -208,7 +209,15 @@ int mosquitto_reinitialise(struct mosquitto *mosq, const char *id, bool clean_st
 #endif
 	mosq->tls_cert_reqs = SSL_VERIFY_PEER;
 	mosq->tls_insecure = false;
-	mosq->want_write = false;
+	mosq->tls_ocsp_required = false;
+#endif
+#ifdef WITH_TLS_MBEDTLS
+	mosq->mbedtls = NULL;
+#ifndef WITH_BROKER
+	mosq->user_mbedtls = NULL;
+#endif
+	mosq->tls_cert_reqs = SSL_VERIFY_PEER;
+	mosq->tls_insecure = false;
 	mosq->tls_ocsp_required = false;
 #endif
 #ifdef WITH_THREADING
@@ -267,7 +276,8 @@ void mosquitto__destroy(struct mosquitto *mosq)
 	}
 	message__cleanup_all(mosq);
 	will__clear(mosq);
-#ifdef WITH_TLS
+
+#ifdef WITH_TLS_OPENSSL
 	if(mosq->ssl){
 		SSL_free(mosq->ssl);
 	}
@@ -282,6 +292,11 @@ void mosquitto__destroy(struct mosquitto *mosq)
 		SSL_CTX_free(mosq->ssl_ctx);
 	}
 #endif
+#endif
+#ifdef WITH_TLS_MBEDTLS
+	mosquitto__mbedtls_cleanup(mosq);
+#endif
+#ifdef WITH_TLS
 	mosquitto__free(mosq->tls_cafile);
 	mosquitto__free(mosq->tls_capath);
 	mosquitto__free(mosq->tls_certfile);
@@ -292,10 +307,8 @@ void mosquitto__destroy(struct mosquitto *mosq)
 	mosquitto__free(mosq->tls_psk);
 	mosquitto__free(mosq->tls_psk_identity);
 	mosquitto__free(mosq->tls_alpn);
-#ifndef OPENSSL_NO_ENGINE
 	mosquitto__free(mosq->tls_engine);
 	mosq->tls_engine = NULL;
-#endif
 #endif
 
 	mosquitto__free(mosq->address);
diff --git a/lib/mosquitto_internal.h b/lib/mosquitto_internal.h
index 8021b3ae..c8265664 100644
--- a/lib/mosquitto_internal.h
+++ b/lib/mosquitto_internal.h
@@ -21,15 +21,22 @@ Contributors:
 #define MOSQUITTO_INTERNAL_H
 
 #include "config.h"
+#include "tls_mosq.h"
 
 #ifdef WIN32
 #  include <winsock2.h>
 #endif
 
 #ifdef WITH_TLS
-#  include <openssl/ssl.h>
-#else
-#  include <time.h>
+#  ifdef WITH_TLS_OPENSSL
+#    include <openssl/ssl.h>
+#  elif defined(WITH_TLS_MBEDTLS)
+#    include <mbedtls/ssl.h>
+#  endif
+#endif
+#include <time.h>
+#ifdef WITH_TLS_MBEDTLS
+#  include "tls_mbedtls.h"
 #endif
 #include <stdlib.h>
 
@@ -252,11 +259,18 @@ struct mosquitto {
 	uint32_t will_delay_interval;
 	time_t will_delay_time;
 #ifdef WITH_TLS
+#  ifdef WITH_TLS_OPENSSL
 	SSL *ssl;
 	SSL_CTX *ssl_ctx;
-#ifndef WITH_BROKER
+#    ifndef WITH_BROKER
 	SSL_CTX *user_ssl_ctx;
-#endif
+#    endif
+#  elif defined(WITH_TLS_MBEDTLS)
+	struct mosq_mbedtls *mbedtls;
+#    ifndef WITH_BROKER
+	struct mosq_mbedtls *user_mbedtls;
+#    endif
+#  endif
 	char *tls_cafile;
 	char *tls_capath;
 	char *tls_certfile;
diff --git a/lib/net_mosq.c b/lib/net_mosq.c
index d9eb81e0..1afd9272 100644
--- a/lib/net_mosq.c
+++ b/lib/net_mosq.c
@@ -54,11 +54,13 @@ Contributors:
 #endif
 
 #ifdef WITH_TLS
-#include <openssl/conf.h>
-#include <openssl/engine.h>
-#include <openssl/err.h>
-#include <openssl/ui.h>
-#include <tls_mosq.h>
+#  ifdef WITH_TLS_OPENSSL
+#    include <openssl/conf.h>
+#    include <openssl/engine.h>
+#    include <openssl/err.h>
+#    include <openssl/ui.h>
+#  endif
+#  include <tls_mosq.h>
 #endif
 
 #ifdef WITH_BROKER
@@ -77,7 +79,7 @@ Contributors:
 #include "time_mosq.h"
 #include "util_mosq.h"
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 int tls_ex_index_mosq = -1;
 UI_METHOD *_ui_method = NULL;
 
@@ -146,7 +148,7 @@ int net__init(void)
 
 void net__cleanup(void)
 {
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 #  if OPENSSL_VERSION_NUMBER < 0x10100000L
 	CRYPTO_cleanup_all_ex_data();
 	ERR_free_strings();
@@ -172,7 +174,7 @@ void net__cleanup(void)
 #endif
 }
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 void net__init_tls(void)
 {
 	if(is_tls_initialized) return;
@@ -196,6 +198,11 @@ void net__init_tls(void)
 
 	is_tls_initialized = true;
 }
+#elif defined(WITH_TLS) && defined(WITH_TLS_MBEDTLS)
+void net__init_tls(void)
+{
+	/* mbedTLS does not require global initialization here. */
+}
 #endif
 
 bool net__is_connected(struct mosquitto *mosq)
@@ -220,9 +227,10 @@ int net__socket_close(struct mosquitto *mosq)
 
 	assert(mosq);
 #ifdef WITH_TLS
-#ifdef WITH_WEBSOCKETS
+#  ifdef WITH_TLS_OPENSSL
+#    ifdef WITH_WEBSOCKETS
 	if(!mosq->wsi)
-#endif
+#    endif
 	{
 		if(mosq->ssl){
 			if(!SSL_in_init(mosq->ssl)){
@@ -232,6 +240,9 @@ int net__socket_close(struct mosquitto *mosq)
 			mosq->ssl = NULL;
 		}
 	}
+#  elif defined(WITH_TLS_MBEDTLS)
+	mosquitto__mbedtls_cleanup(mosq);
+#  endif
 #endif
 
 #ifdef WITH_WEBSOCKETS
@@ -537,7 +548,7 @@ int net__try_connect(const char *host, uint16_t port, mosq_sock_t *sock, const c
 }
 
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS_OPENSSL)
 void net__print_ssl_error(struct mosquitto *mosq)
 {
 	char ebuf[256];
@@ -579,7 +590,7 @@ int net__socket_connect_tls(struct mosquitto *mosq)
 #endif
 
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS_OPENSSL)
 static int net__tls_load_ca(struct mosquitto *mosq)
 {
 	int ret;
@@ -860,7 +871,7 @@ static int net__init_ssl_ctx(struct mosquitto *mosq)
 
 int net__socket_connect_step3(struct mosquitto *mosq, const char *host)
 {
-#ifdef WITH_TLS
+#if defined(WITH_TLS_OPENSSL)
 	BIO *bio;
 
 	int rc = net__init_ssl_ctx(mosq);
@@ -903,6 +914,12 @@ int net__socket_connect_step3(struct mosquitto *mosq, const char *host)
 		}
 
 	}
+#elif defined(WITH_TLS_MBEDTLS)
+	int rc = mosquitto__mbedtls_connect(mosq, host);
+	if(rc){
+		net__socket_close(mosq);
+		return rc;
+	}
 #else
 	UNUSED(mosq);
 	UNUSED(host);
@@ -939,7 +956,7 @@ int net__socket_connect(struct mosquitto *mosq, const char *host, uint16_t port,
 }
 
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 static void net__handle_ssl(struct mosquitto* mosq, int ret)
 {
 	int err;
@@ -975,6 +992,7 @@ ssize_t net__read(struct mosquitto *mosq, void *buf, size_t count)
 	assert(mosq);
 	errno = 0;
 #ifdef WITH_TLS
+#  ifdef WITH_TLS_OPENSSL
 	if(mosq->ssl){
 		ERR_clear_error();
 		ret = SSL_read(mosq->ssl, buf, (int)count);
@@ -982,7 +1000,13 @@ ssize_t net__read(struct mosquitto *mosq, void *buf, size_t count)
 			net__handle_ssl(mosq, ret);
 		}
 		return (ssize_t )ret;
-	}else{
+	}else
+#  elif defined(WITH_TLS_MBEDTLS)
+	if(mosq->mbedtls){
+		return mosquitto__mbedtls_read(mosq, buf, count);
+	}else
+#  endif
+	{
 		/* Call normal read/recv */
 
 #endif
@@ -1007,6 +1031,7 @@ ssize_t net__write(struct mosquitto *mosq, const void *buf, size_t count)
 
 	errno = 0;
 #ifdef WITH_TLS
+#  ifdef WITH_TLS_OPENSSL
 	if(mosq->ssl){
 		ERR_clear_error();
 		mosq->want_write = false;
@@ -1015,7 +1040,13 @@ ssize_t net__write(struct mosquitto *mosq, const void *buf, size_t count)
 			net__handle_ssl(mosq, ret);
 		}
 		return (ssize_t )ret;
-	}else{
+	}else
+#  elif defined(WITH_TLS_MBEDTLS)
+	if(mosq->mbedtls){
+		return mosquitto__mbedtls_write(mosq, buf, count);
+	}else
+#  endif
+	{
 		/* Call normal write/send */
 #endif
 
@@ -1183,15 +1214,20 @@ int net__socketpair(mosq_sock_t *pairR, mosq_sock_t *pairW)
 }
 #endif
 
-#ifndef WITH_BROKER
+#if !defined(WITH_BROKER) && defined(WITH_TLS_OPENSSL)
 void *mosquitto_ssl_get(struct mosquitto *mosq)
 {
 #ifdef WITH_TLS
-	return mosq->ssl;
+	return mosq ? mosq->ssl : NULL;
 #else
 	UNUSED(mosq);
-
 	return NULL;
 #endif
 }
+#elif !defined(WITH_BROKER)
+void *mosquitto_ssl_get(struct mosquitto *mosq)
+{
+	UNUSED(mosq);
+	return NULL;
+}
 #endif
diff --git a/lib/net_mosq.h b/lib/net_mosq.h
index 2e6155b3..7125291d 100644
--- a/lib/net_mosq.h
+++ b/lib/net_mosq.h
@@ -80,7 +80,7 @@ bool net__is_connected(struct mosquitto *mosq);
 ssize_t net__read(struct mosquitto *mosq, void *buf, size_t count);
 ssize_t net__write(struct mosquitto *mosq, const void *buf, size_t count);
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 void net__print_ssl_error(struct mosquitto *mosq);
 int net__socket_apply_tls(struct mosquitto *mosq);
 int net__socket_connect_tls(struct mosquitto *mosq);
@@ -90,6 +90,8 @@ UI_METHOD *net__get_ui_method(void);
 #define ENGINE_SECRET_MODE "SECRET_MODE"
 #define ENGINE_SECRET_MODE_SHA 0x1000
 #define ENGINE_PIN "PIN"
+#else
+#define ENGINE_FINISH(e)
 #endif
 
 #endif
diff --git a/lib/net_mosq_ocsp.c b/lib/net_mosq_ocsp.c
index 34a29ebc..1d6f9144 100644
--- a/lib/net_mosq_ocsp.c
+++ b/lib/net_mosq_ocsp.c
@@ -44,7 +44,7 @@ in this Software without prior written authorization of the copyright holder.
 
 #include "config.h"
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 #include <logging_mosq.h>
 #include <mosquitto_internal.h>
 #include <net_mosq.h>
diff --git a/lib/options.c b/lib/options.c
index cb2fb1ad..c11b74d0 100644
--- a/lib/options.c
+++ b/lib/options.c
@@ -28,7 +28,10 @@ Contributors:
 #  ifdef WIN32
 #    include <winsock2.h>
 #  endif
-#  include <openssl/engine.h>
+#  ifdef WITH_TLS_OPENSSL
+#    include <openssl/engine.h>
+#    include <openssl/ssl.h>
+#  endif
 #endif
 
 #include "mosquitto.h"
@@ -280,8 +283,10 @@ int mosquitto_tls_insecure_set(struct mosquitto *mosq, bool value)
 
 int mosquitto_string_option(struct mosquitto *mosq, enum mosq_opt_t option, const char *value)
 {
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 	ENGINE *eng;
+#endif
+#ifdef WITH_TLS
 	char *str;
 #endif
 
@@ -289,7 +294,7 @@ int mosquitto_string_option(struct mosquitto *mosq, enum mosq_opt_t option, cons
 
 	switch(option){
 		case MOSQ_OPT_TLS_ENGINE:
-#if defined(WITH_TLS) && !defined(OPENSSL_NO_ENGINE)
+#if defined(WITH_TLS_OPENSSL) && !defined(OPENSSL_NO_ENGINE)
 			mosquitto__free(mosq->tls_engine);
 			if(value){
 #if OPENSSL_VERSION_NUMBER >= 0x10100000L
@@ -314,7 +319,7 @@ int mosquitto_string_option(struct mosquitto *mosq, enum mosq_opt_t option, cons
 			break;
 
 		case MOSQ_OPT_TLS_KEYFORM:
-#ifdef WITH_TLS
+#ifdef WITH_TLS_OPENSSL
 			if(!value) return MOSQ_ERR_INVAL;
 			if(!strcasecmp(value, "pem")){
 				mosq->tls_keyform = mosq_k_pem;
@@ -331,7 +336,7 @@ int mosquitto_string_option(struct mosquitto *mosq, enum mosq_opt_t option, cons
 
 
 		case MOSQ_OPT_TLS_ENGINE_KPASS_SHA1:
-#ifdef WITH_TLS
+#ifdef WITH_TLS_OPENSSL
 			if(mosquitto__hex2bin_sha1(value, (unsigned char**)&str) != MOSQ_ERR_SUCCESS){
 				return MOSQ_ERR_INVAL;
 			}
@@ -472,15 +477,15 @@ int mosquitto_int_option(struct mosquitto *mosq, enum mosq_opt_t option, int val
 			break;
 
 		case MOSQ_OPT_SSL_CTX_WITH_DEFAULTS:
-#if defined(WITH_TLS) && OPENSSL_VERSION_NUMBER >= 0x10100000L
-			if(value){
-				mosq->ssl_ctx_defaults = true;
-			}else{
-				mosq->ssl_ctx_defaults = false;
-			}
-			break;
+#if defined(WITH_TLS_OPENSSL) && OPENSSL_VERSION_NUMBER >= 0x10100000L
+		if(value){
+			mosq->ssl_ctx_defaults = true;
+		}else{
+			mosq->ssl_ctx_defaults = false;
+		}
+		break;
 #else
-			return MOSQ_ERR_NOT_SUPPORTED;
+		return MOSQ_ERR_NOT_SUPPORTED;
 #endif
 
 		case MOSQ_OPT_TLS_USE_OS_CERTS:
@@ -496,7 +501,7 @@ int mosquitto_int_option(struct mosquitto *mosq, enum mosq_opt_t option, int val
 #endif
 
 		case MOSQ_OPT_TLS_OCSP_REQUIRED:
-#ifdef WITH_TLS
+#ifdef WITH_TLS_OPENSSL
 			mosq->tls_ocsp_required = (bool)value;
 #else
 			return MOSQ_ERR_NOT_SUPPORTED;
@@ -520,7 +525,7 @@ int mosquitto_void_option(struct mosquitto *mosq, enum mosq_opt_t option, void *
 
 	switch(option){
 		case MOSQ_OPT_SSL_CTX:
-#ifdef WITH_TLS
+#if defined(WITH_TLS_OPENSSL)
 			mosq->user_ssl_ctx = (SSL_CTX *)value;
 			if(mosq->user_ssl_ctx){
 #if (OPENSSL_VERSION_NUMBER >= 0x10100000L)
diff --git a/lib/tls_mosq.c b/lib/tls_mosq.c
index f85379ed..4d8ea5b9 100644
--- a/lib/tls_mosq.c
+++ b/lib/tls_mosq.c
@@ -18,7 +18,7 @@ Contributors:
 
 #include "config.h"
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 
 #ifdef WIN32
 #  include <winsock2.h>
diff --git a/lib/tls_mosq.h b/lib/tls_mosq.h
index ae175d9e..6953d177 100644
--- a/lib/tls_mosq.h
+++ b/lib/tls_mosq.h
@@ -19,13 +19,23 @@ Contributors:
 #ifndef TLS_MOSQ_H
 #define TLS_MOSQ_H
 
+#ifdef WITH_TLS_MBEDTLS
+#  include "tls_mbedtls.h"
+#endif
+
 #ifdef WITH_TLS
-#  define SSL_DATA_PENDING(A) ((A)->ssl && SSL_pending((A)->ssl))
+#  ifdef WITH_TLS_OPENSSL
+#    define SSL_DATA_PENDING(A) ((A)->ssl && SSL_pending((A)->ssl))
+#  elif defined(WITH_TLS_MBEDTLS)
+#    define SSL_DATA_PENDING(A) ((A)->mbedtls && mbedtls_ssl_get_bytes_avail(&(A)->mbedtls->ssl))
+#  else
+#    define SSL_DATA_PENDING(A) 0
+#  endif
 #else
 #  define SSL_DATA_PENDING(A) 0
 #endif
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS) && defined(WITH_TLS_OPENSSL)
 
 #include <openssl/ssl.h>
 #include <openssl/engine.h>
@@ -33,6 +43,16 @@ Contributors:
 int mosquitto__server_certificate_verify(int preverify_ok, X509_STORE_CTX *ctx);
 int mosquitto__verify_certificate_hostname(X509 *cert, const char *hostname);
 
-#endif /* WITH_TLS */
+#else
+
+#ifndef SSL_VERIFY_NONE
+#  define SSL_VERIFY_NONE 0
+#endif
+
+#ifndef SSL_VERIFY_PEER
+#  define SSL_VERIFY_PEER 1
+#endif
+
+#endif /* WITH_TLS && WITH_TLS_OPENSSL */
 
 #endif
diff --git a/lib/util_mosq.c b/lib/util_mosq.c
index bed940b4..aed42c6c 100644
--- a/lib/util_mosq.c
+++ b/lib/util_mosq.c
@@ -31,15 +31,14 @@ Contributors:
 #  include <sys/stat.h>
 #endif
 
-#if !defined(WITH_TLS) && defined(__linux__) && defined(__GLIBC__)
+#if !defined(WITH_TLS_OPENSSL) && defined(__linux__) && defined(__GLIBC__)
 #  if __GLIBC_PREREQ(2, 25)
 #    include <sys/random.h>
 #    define HAVE_GETRANDOM 1
 #  endif
 #endif
 
-#ifdef WITH_TLS
-#  include <openssl/bn.h>
+#ifdef WITH_TLS_OPENSSL
 #  include <openssl/rand.h>
 #endif
 
@@ -165,55 +164,70 @@ uint16_t mosquitto__mid_generate(struct mosquitto *mosq)
 
 
 #ifdef WITH_TLS
+
+#define MOSQ_SHA1_BYTES 20
+
+static int mosq__hex2nibble(char c)
+{
+	if(c >= '0' && c <= '9'){
+		return c - '0';
+	}else if(c >= 'a' && c <= 'f'){
+		return 10 + (c - 'a');
+	}else if(c >= 'A' && c <= 'F'){
+		return 10 + (c - 'A');
+	}
+	return -1;
+}
+
 int mosquitto__hex2bin_sha1(const char *hex, unsigned char **bin)
 {
-	unsigned char *sha, tmp[SHA_DIGEST_LENGTH];
+	unsigned char *sha;
+	unsigned char tmp[MOSQ_SHA1_BYTES];
+	int expected_len = (int)sizeof(tmp);
 
-	if(mosquitto__hex2bin(hex, tmp, SHA_DIGEST_LENGTH) != SHA_DIGEST_LENGTH){
+	if(mosquitto__hex2bin(hex, tmp, expected_len) != expected_len){
 		return MOSQ_ERR_INVAL;
 	}
 
-	sha = mosquitto__malloc(SHA_DIGEST_LENGTH);
+	sha = mosquitto__malloc(expected_len);
 	if(!sha){
 		return MOSQ_ERR_NOMEM;
 	}
-	memcpy(sha, tmp, SHA_DIGEST_LENGTH);
+	memcpy(sha, tmp, expected_len);
 	*bin = sha;
 	return MOSQ_ERR_SUCCESS;
 }
 
 int mosquitto__hex2bin(const char *hex, unsigned char *bin, int bin_max_len)
 {
-	BIGNUM *bn = NULL;
-	int len;
-	int leading_zero = 0;
-	int start = 0;
-	size_t i = 0;
-
-	/* Count the number of leading zero */
-	for(i=0; i<strlen(hex); i=i+2) {
-		if(strncmp(hex + i, "00", 2) == 0) {
-			leading_zero++;
-			/* output leading zero to bin */
-			bin[start++] = 0;
-		}else{
-			break;
-		}
-	}
+	size_t hex_len;
+	int out_len = 0;
+	int hi, lo;
+	size_t i;
 
-	if(BN_hex2bn(&bn, hex) == 0){
-		if(bn) BN_free(bn);
+	if(!hex || !bin || bin_max_len <= 0){
 		return 0;
 	}
-	if(BN_num_bytes(bn) + leading_zero > bin_max_len){
-		BN_free(bn);
+	hex_len = strlen(hex);
+	if(hex_len == 0 || hex_len % 2 != 0){
 		return 0;
 	}
 
-	len = BN_bn2bin(bn, bin + leading_zero);
-	BN_free(bn);
-	return len + leading_zero;
+	for(i = 0; i < hex_len; i += 2){
+		hi = mosq__hex2nibble(hex[i]);
+		lo = mosq__hex2nibble(hex[i+1]);
+		if(hi < 0 || lo < 0){
+			return 0;
+		}
+		if(out_len >= bin_max_len){
+			return 0;
+		}
+		bin[out_len++] = (unsigned char)((hi << 4) | lo);
+	}
+
+	return out_len;
 }
+#undef MOSQ_SHA1_BYTES
 #endif
 
 void util__increment_receive_quota(struct mosquitto *mosq)
@@ -250,7 +264,7 @@ int util__random_bytes(void *bytes, int count)
 {
 	int rc = MOSQ_ERR_UNKNOWN;
 
-#ifdef WITH_TLS
+#if defined(WITH_TLS_OPENSSL)
 	if(RAND_bytes(bytes, count) == 1){
 		rc = MOSQ_ERR_SUCCESS;
 	}
