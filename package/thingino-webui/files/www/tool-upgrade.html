<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>thingino Â· Flash Operations</title>
  <link rel="icon" type="image/svg+xml" href="/a/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/a/main.css">
</head>

<body id="page-tool-upgrade">
<nav data-app-nav></nav>

<main class="pb-4">
  <div class="container" style="min-height:80vh">
    <div data-app-controls></div>

    <section>
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">Flash operations</h2>
          <small>Create a backup, trigger OTA upgrade, or upload a verified image without touching the shell.</small>
          <button type="button" class="btn btn-outline-secondary" id="refreshState" title="Reload values from camera">
            <i class="bi bi-arrow-clockwise"></i> Reload
          </button>
        </div><!-- .card-header -->
        <div class="card-body">
          <div class="row">

            <div class="col-6">
              <h4>Thingino OTA update</h4>
              <small>Fetch the latest signed image from GitHub and run sysupgrade with the selected scope.</small>
              <div class="vstack gap-2 mb-3">
                <div class="form-check border rounded-3 p-2 position-relative">
                  <input type="radio" name="otaOption" value="full" id="ota-full" class="form-check-input position-absolute top-50 translate-middle-y" style="left:1rem" checked>
                  <label for="ota-full" class="form-check-label d-block ms-3">
                    <span class="fw-semibold">Full image</span><br>
                    <span class="small">Will erase everything and install a pristine new image. No customization will survive. You will have to reconfigure the system from scratch.
                      <span class="text-warning">RECOMMENDED</span></span>
                  </label>
                </div>
                <div class="form-check border rounded-3 p-2 position-relative">
                  <input type="radio" name="otaOption" value="partial" id="ota-partial" class="form-check-input position-absolute top-50 translate-middle-y" style="left:1rem">
                  <label for="ota-partial" class="form-check-label d-block ms-3">
                    <span class="fw-semibold">Partial update</span><br>
                    <span class="small">Will keep overlay partition with customizations. Most likely will end up in conflicts, so you might need to reset and reconfigure the system. <span class="text-warning">USE AT YOUR OWN RISK</span></span>
                  </label>
                </div>
                <div class="form-check border rounded-3 p-2 position-relative">
                  <input type="radio" name="otaOption" value="bootloader" id="ota-bootloader" class="form-check-input position-absolute top-50 translate-middle-y" style="left:1rem">
                  <label for="ota-bootloader" class="form-check-label d-block ms-3">
                    <span class="fw-semibold">Bootloader</span><br>
                    <span class="small">Upgrades just the bootloader. This is not a normal operation and should only be done when instructed by a developer.</span>
                  </label>
                </div>
              </div>
              <p class="text-warning small">OTA upgrade will reboot the camera when it finishes.</p>
              <button type="button" class="btn btn-danger" id="otaRun">
                <i class="bi bi-cloud-arrow-down me-1"></i>Download and Upgrade
              </button>
            </div>

            <div class="col-3">
              <h4>Manual sysupgrade image</h4>
              <small>Upload and flash a verified .bin file.</small>
              <p>
                <label for="firmwareInput">Firmware image</label>
                <input type="file" class="form-control" id="firmwareInput" accept=".bin,.img,.gz">
              </p>
              <p class="alert alert-danger small">Uploading an invalid image may render the device unresponsive!</p>
              <button type="button" class="btn btn-danger mb-1" id="uploadButton" disabled>
                <i class="bi bi-upload me-1"></i>Upload and Flash
              </button>
              <p class="text-secondary small">Staged at /tmp/fw-web.bin</p>
            </div>

            <div class="col d-none">
              <h4>MTD partition dump</h4>
              <small>Saves a raw /dev/mtdX block for low-level recovery work.</small>
              <p class="text-warning small">Dumping flash partitions is intended for recovery experts.</p>
              <p>
                <label for="partitionSelect">Partition</label>
                <select class="form-select" id="partitionSelect"></select>
              </p>
              <button type="button" class="btn btn-primary mb-3" id="partitionDownload">
                <i class="bi bi-box-arrow-down me-1"></i>Save mtdblock
              </button>
            </div>

            <div class="col-3">
              <h4>Back up the configuration</h4>
              <small>Download customizations as an archive.</small>
              <p class="alert alert-warning small">The archive includes Wi-Fi credentials, SSH certificates, and accounts for various services. Store securely!</p>
              <p class="small">Please note that there is no restoration procedure!
                The saved configuration files may not be compatible with the latest changes.
                Use them only as a reference for creating a new configuration.</p>
              <button type="button" class="btn btn-primary" id="backupButton">
                <i class="bi bi-download me-1"></i>Generate archive
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Flash Progress Modal -->
<div class="modal fade" id="flashProgressModal" tabindex="-1" aria-labelledby="flashProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-fullscreen-md-down" style="height: 80vh; max-height: 80vh;">
    <div class="modal-content h-100 d-flex flex-column">
      <div class="modal-header flex-shrink-0">
        <h5 class="modal-title" id="flashProgressModalLabel">Flash Progress</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body flex-grow-1 overflow-hidden p-0" style="min-height: 0;">
        <pre id="output" class="terminal ansi-log overflow-auto h-100 m-0" data-reboot="true"></pre>
      </div>
      <div class="modal-footer flex-shrink-0">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="copyLog" disabled>
          <i class="bi bi-clipboard me-1"></i>Copy Log
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<footer data-app-footer></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script src="/a/main.js"></script>
<script src="/a/runtime-config.js"></script>
<script src="/a/navigation.js"></script>
<script src="/a/footer.js"></script>
<script src="/a/tool-upgrade.js"></script>
</body>
</html>
