#!/bin/sh
#set -euo pipefail

. /usr/share/common

OS_RELEASE_FILE=${OS_RELEASE_FILE:-/etc/os-release}
WEBUI_JS_CONFIG=${WEBUI_JS_CONFIG:-/var/www/a/runtime-config.js}

escape() {
  printf '%s' "$1" | sed 's/\\/\\\\/g; s/"/\\"/g'
}

if [ ! -f "$OS_RELEASE_FILE" ]; then
  echo >&2 "Missing $OS_RELEASE_FILE"
  exit 1
fi

start() {
  if [ -f "$WEBUI_JS_CONFIG" ]; then
    echo_info "File $WEBUI_JS_CONFIG exists"
    exit 0
  fi

  hostname="$(hostname -s)"
  timezone="$(cat /etc/timezone 2>/dev/null || echo UTC)"
  image_id="$(awk -F= '/^IMAGE_ID=/{gsub(/"/, "", $2); print $2}' "$OS_RELEASE_FILE")"
  build_time="$(awk -F= '/^BUILD_TIME=/{gsub(/"/, "", $2); print $2}' "$OS_RELEASE_FILE")"
  build_commit="$(awk -F'[=,"]' '/^COMMIT_ID/{print $3}' "$OS_RELEASE_FILE")"
  motors_enabled="false"
  if [ -f /etc/motors.json ]; then
    motors_enabled="true"
  fi

  {
    echo "// generated at $(date +%c)"
    echo "window.thinginoUIConfig = window.thinginoUIConfig || {};"
    echo "window.thinginoUIConfig.footer = Object.assign({}, window.thinginoUIConfig.footer, {"
    echo "  host: \"$(escape "$hostname")\","
    echo "  buildInfo: \"$(escape "$image_id · $build_commit · $build_time")\""
    echo "});"
    echo "window.thinginoUIConfig.device = Object.assign({}, window.thinginoUIConfig.device, {"
    echo "  timezone: \"$(escape "$timezone")\","
    echo "  motors: $motors_enabled"
    echo "});"
    echo "window.thinginoFooterConfig = window.thinginoUIConfig.footer;"
  } > "$WEBUI_JS_CONFIG"
}

stop() {
  true
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  *)
    echo "Usage: $0 [start|stop]"
    exit 1
    ;;
esac

exit 0
