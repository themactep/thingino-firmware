#!/tmp/busybox sh

export PATH="/tmp/sysupgrade"
echo "stage 2 PATH is $PATH"

echo_c() { echo -e "\e[38;5;$1m$2\e[0m"; }

die() { echo_c 160 "$1"; exit 1; }

flash_firmware() {
	echo "Flashing firmware to $mtd_dev"
	flashcp -v $fw_file $mtd_dev
}

# Detach from terminal and protect against disconnections during flash
detach_and_flash() {
	logfile="/tmp/sysupgrade-flash.log"

	echo_c 208 "CRITICAL PHASE: Detaching from terminal to protect against connection loss..."
	echo "Process will continue even if SSH disconnects."
	echo "Log file: $logfile"
	echo ""

	# Run in subshell detached from terminal
	(
		# Protect against all signals during flash
		trap '' HUP INT TERM

		exec >$logfile 2>&1

		echo "=== Flash operation started at $(date) ==="

		MAX_TRIES=3
		x=0
		times=""
		while :; do
			x=$((x+1))
			if flash_firmware; then
				echo "=== Flash completed successfully at $(date) ==="
				echo "Rebooting in 5 seconds..."
				sleep 5
				echo wdt > /proc/jz/reset/reset
				exit 0
			fi
			[ $x -gt 1 ] && times=" $x times"
			echo "Flashing failed${times}."
			[ $x -gt $MAX_TRIES ] && break
			echo "Retrying in 5 seconds..."
			sleep 5
		done
		echo "Flashing failed after $MAX_TRIES attempts!"
		echo "WARNING: You may need to perform a recovery flash restore before rebooting the camera!"
		exit 1
	) </dev/null &

	flash_pid=$!
	echo "Flash process running with PID $flash_pid (safe to disconnect)"

	# Monitor the process
	sleep 2
	while kill -0 $flash_pid 2>/dev/null; do
		[ -f "$logfile" ] && tail -n 3 $logfile 2>/dev/null
		sleep 2
	done

	# Get exit status
	wait $flash_pid
	exit $?
}

go_reboot() {
	echo "Rebooting in 5 seconds..."
	sleep 5
	echo wdt > /proc/jz/reset/reset
	exit 0
}

[ -z "$1" ] && die "Firmware file is not set."
[ -z "$2" ] && die "Target device is not set."

fw_file=$1
mtd_dev="/dev/$2"

echo_c 208 "Running Stage 2 of sysupgrade."
echo "Firmware: $fw_file"
echo "Target: $mtd_dev"
echo ""
echo "You can still press Ctrl-C to abort before flashing starts."
echo ""

# Call the detached flash function which will protect the session
detach_and_flash
