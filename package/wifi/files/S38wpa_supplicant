#!/bin/sh

. /usr/share/common

IFACE=wlan0
CONFIG="/etc/$DAEMON_SHORT.conf"
PIDFILE="/run/$DAEMON_SHORT.$IFACE.pid"
WLAN_INT_FILE="/etc/network/interfaces.d/wlan0"
DAEMON_ARGS="-i $IFACE -c $CONFIG -P $PIDFILE -B"

if [ "true" = "$debug" ]; then
	DAEMON_ARGS="$DAEMON_ARGS -dd"
fi

password_changed() {
	old_pass=$(awk -F= '/^\s*psk=/{gsub(/^"|"$/, "", $2); print $2}' $CONFIG)
	[ "$old_pass" != "$wlan_pass" ]
}

ssid_changed() {
	old_ssid=$(awk -F= '/^\s*ssid=/{gsub(/^"|"$/, "", $2); print $2}' $CONFIG)
	[ "$old_ssid" != "$wlan_ssid" ]
}

start() {
	echo_title "Starting WPA Supplicant"

	     wlan_pass=$(jct /etc/thingino.json get wlan.pass       2>/dev/null || fw_printenv -n wlan_pass)
	      wlan_psk=$(jct /etc/thingino.json get wlan.psk        2>/dev/null || fw_printenv -n wlan_psk)
	     wlan_ssid=$(jct /etc/thingino.json get wlan.ssid       2>/dev/null || fw_printenv -n wlan_ssid)
	    wlan_bssid=$(jct /etc/thingino.json get wlan.bssid      2>/dev/null || fw_printenv -n wlan_bssid)
	wlanap_enabled=$(jct /etc/thingino.json get wlan_ap.enabled 2>/dev/null || fw_printenv -n wlanap_enabled)

	if ! iface_exists "wlan0"; then
		echo_error "No wireless interface"
		exit 1
	fi

	if [ "${wlan_ssid}${wlan_bssid}" = "" ]; then
		echo_error "WiFi network missing"
		exit 1
	fi

	if [ "${wlan_psk}${wlan_pass}" = "" ]; then
		echo_error "WiFi password missing"
		exit 1
	fi

	if grep -q "^#auto wlan0" $WLAN_INT_FILE; then
		echo_error "wlan0 manually disabled"
		exit 1
	fi

	if [ ${#wlan_psk} -eq 64 ]; then
		echo_info "Wi-Fi PSK found"
	elif [ ${#wlan_pass} -gt 0 ] && [ ${#wlan_pass} -lt 64 ]; then
		echo_info "Wi-Fi password found, converting to PSK"
		wlan_psk=$(convert_psk "$wlan_ssid" "$wlan_pass")
		cp /etc/thingino.json /root/thingino.json.before
		jct /etc/thingino.json set wlan.psk "$wlan_psk" 2>/dev/null
		cp /etc/thingino.json /root/thingino.json.after
	else
		echo_error "Invalid length of Wi-Fi password/PSK"
		exit 1
	fi

	if [ ! -f "$CONFIG" ] || ssid_changed || password_changed; then
		wpa_passphrase "$wlan_ssid" "dummy_password" > $CONFIG
		sed -i "s/psk=.*$/psk=${wlan_psk}/" $CONFIG
		if [ -n "$wlan_bssid" ]; then
			sed -i "s/^\s*ssid=.*$/\tbssid=$wlan_bssid/" $CONFIG
		else
			sed -i '/}/i\\tscan_ssid=1' $CONFIG
		fi
	fi

	if [ "true" = "$wlanap_enabled" ]; then
		echo_error "WLAN AP enabled"
		exit 1
	fi

	start-stop-daemon -S -x $DAEMON_FULL -- $DAEMON_ARGS 2>&1
}

stop() {
	echo_title "Stopping WPA Supplicant"

	stop_daemon
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		stop
		start
		;;
	*)
		echo "Usage: $0 {start|stop|restart|reload}"
		exit 1
		;;
esac

exit 0
